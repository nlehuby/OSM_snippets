<!DOCTYPE html>
<html>
<head>
  <title>OSM & navitia bus route comparing tools</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <script src="assets/OverPassLayer.js"></script>
  <script src="assets/auth.js"></script>  
  <script src="assets/api.js"></script>  
  <script src="assets/osmtogeojson.js"></script>  
  <script src="assets/easy-button.js"></script> 
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 97%;
      width: 100%;
    }
    #info {
      height: 8%;
      width: 100%;
    }
  </style>
</head>
<body>
<div id="info"> 
<table>

<tr>
    <td>
        <div>parcours navitia : <a href='http://api.navitia.io/v1/coverage/fr-idf/routes/%%navitia_route_extcode%%' target='_blank'> %%navitia_route_name%%</a>
        </div> 
    </td>
    <td rowspan=2>
        <progress value="%%OSM_nb_stops%%" max="%%navitia_nb_stops%%">état de la carto de la route</progress> <br/> <small>mis à jour le %%date_du_jour%%</small>
    </td>
</tr>
<tr><td><div id="parcours_OSM">parcours OSM ... </div></td> </tr>

</table>

</div>
  <div id="map"></div>
  <script>
	  var attr_osm = 'Map data &copy; <a href="http://openstreetmap.org/">OpenStreetMap</a> contributors',
      attr_overpass = 'POI via <a href="http://www.overpass-api.de/">Overpass API</a> and <a href="http://navitia.io/">navitia.io</a>';
    var osm = new L.TileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {opacity: 0.7, attribution: [attr_osm, attr_overpass].join(', ')});

		var map = new L.Map('map').addLayer(osm).setView(new L.LatLng(48.84702,2.37705), 14);
		
		var osm_relation_code = %%OSM_relation_code%%

    
//navitia layer
  var latLongCollection = []; 
  var geojson =   [%%navitia_route_geojson%%];
  
  var locations_navitia = L.geoJson(geojson);
  
    locations_navitia.eachLayer(function(locale) {

    // Shorten locale.feature.properties to just `prop` so we're not
    // writing this long form over and over again.
    var prop = locale.feature.properties;

    // Each marker on the map.
    var popup = '<h3>'+prop.name+'</h3><div><a href="http://api.navitia.io/v1/coverage/fr-idf/stop_points/' + prop.code + '" target="_blank"> voir le détail</a></div>';

    locale.bindPopup(popup);
    latLongCollection.push(locale._latlng)

    locale.setIcon(L.icon({
      iconUrl: 'assets/navitia_bus.png',
      popupAnchor: [0, 0]
    }));

});


relation_OSM_url = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];relation('+ osm_relation_code +');(._;>;);out;'
getJSON(relation_OSM_url , function(data) {
	 // rcupration du nom
	relation = data.elements.reverse()[0]
	var route_name=document.getElementById("parcours_OSM");
	route_name.innerHTML = "parcours OSM : <a  target='_blank' href='http://openstreetmap.org/relation/"+ relation['id'] +"'>" + relation['tags']['name'] + "</a>"
	
	//transformation en geosjon
    geo = osmtogeojson(data);  
   
   // marqueur pour les lments qu'on ne veut pas voir
	var geojsonBlankMarkerOptions = {
		radius: 8,
		fillColor: "#ff7800",
		color: "#000",
		weight: 0,
		opacity: 0,
		fillOpacity: 0
	};
	// marqueur pour les stop_position
	var geojsonMarkerOptions = {
		radius: 10,
		fillColor: "blue",
		color: "blue",
		weight: 1,
		opacity: 1,
		fillOpacity: 0.8
	};
	//fonction qui transforme les points du geojson en qqch d'affichable
	function DisplayOSMBusStops(feature, latlng){
		if (feature.properties['type'] == 'node') {
			if (feature.properties['tags']['highway'] == 'bus_stop' ) {	
			//console.log(feature.properties)
		    var myicon = L.icon({
                      iconUrl: 'assets/blue_bus.png',
                  });
			return L.marker(latlng, {icon: myicon})
			}
			else if (feature.properties['tags']['public_transport'] == 'stop_position') {return L.circleMarker(latlng, geojsonMarkerOptions)}
			else { return L.circleMarker(latlng, geojsonBlankMarkerOptions)}
		}
	}
    
	//fonction qui affine les proprits du geosjon
    function onEachFeature(feature, layer) {
		if (feature.properties['type'] == 'node') {
			if (feature.properties['tags']['highway'] == 'bus_stop'|| feature.properties['tags']['public_transport'] == 'stop_position' ) {	
				layer.bindPopup(feature.properties.tags.name + '<br><a href="http://www.openstreetmap.org/node/'+ feature.properties['id'] +'" target="_blank">Voir sur OSM</a>');
			} 
		}
		if (feature.properties['type'] == 'way') {
				layer.setStyle({"color": "blue"});
		}
    }
    
    //affichage du geojson
    relation_OSM = L.geoJson(geo, {
        onEachFeature: onEachFeature, 
        pointToLayer : DisplayOSMBusStops
    }).addTo(map);
	
}, function(status) {
  console.log(status)
  alert("Il y a eu un souci dans l'affichage des donnes osm");
});

var elements = []
function getJSON(url, successHandler, errorHandler){
  var xhr = typeof XMLHttpRequest != 'undefined'
    ? new XMLHttpRequest()
    : new ActiveXObject('Microsoft.XMLHTTP');
  xhr.open('get', url, true);
  xhr.onreadystatechange = function() {
    var status;
    var data;
    // http://xhr.spec.whatwg.org/#dom-xmlhttprequest-readystate
    if (xhr.readyState == 4) { // `DONE`
      status = xhr.status;
      if (status == 200) {
        data = JSON.parse(xhr.responseText);
        successHandler && successHandler(data);
      } else {
        errorHandler && errorHandler(status);
      }
    }
  };
  xhr.send();
};  
  

	map.addLayer(locations_navitia);

   
//centrage de la carte    
map.fitBounds(latLongCollection) 

//dition OSM
function add_stop_to_relation(node_id, relation_id){
    var osmXml = get_node_or_way(node_id, 'node');
    edit_tag(osmXml, 'node', "fixme:relation", "add to "+ relation_id); 
    //Open changeset
    changeset_id = put_changeset();
    //Send new node/way
    put_node_or_way(osmXml, changeset_id, node_id, 'node');
    //Close changeset
    close_changeset(changeset_id);
    console.log("arrêt " + node_id.toString() + " marqué comme à ajouter à la relation " + relation_id)
}

function remove_stop_from_relation(node_id, relation_id){
    var osmXml = get_node_or_way(node_id, 'node');
    edit_tag(osmXml, 'node', "fixme:relation", "remove from "+ relation_id); 
    //Open changeset
    changeset_id = put_changeset();
    //Send new node/way
    put_node_or_way(osmXml, changeset_id, node_id, 'node');
    //Close changeset
    close_changeset(changeset_id);
} 
function display_bus_around(){
    center = map.getCenter();
    user_lat = center.lat;
    user_lon = center.lng;
    //[out:json][timeout:25];(node["highway"="bus_stop"](around:500,48.80423,2.36547);)->.a;rel(bn);out body;.a out body;
    url_op_bus = 'http://overpass-api.de/api/interpreter?data=[out:json][timeout:25];(node["highway"="bus_stop"](around:500,' + user_lat +',' + user_lon +');)->.a;rel(bn);out body;.a out body;';
    
    $.getJSON(url_op_bus, function(data) {

// add to map
        geo = osmtogeojson(data);
        for (i = 0; i < geo.features.length; i++) {
            if (geo.features[i].properties['type'] == 'node' && geo.features[i].properties['tags']['highway'] == 'bus_stop' ){
                    relations_text = '';
                    already_in = false;
			        for (j = 0; j < geo.features[i].properties['relations'].length; j++) 
			        {
			         if (geo.features[i].properties['relations'][j]['reltags']['route'] )
		                {
		                relations_text += geo.features[i].properties['relations'][j]['reltags']['name'] + " <br> "
		                if (geo.features[i].properties['relations'][j]['rel'] == osm_relation_code) {already_in = true;}
		                }
			        
                    }  
                             
                    tags = geo.features[i].properties.tags
                    var tags_text = '<ul>';
                    for (key in tags)
                        {tags_text += '<li> ' + key + ' : ' + tags[key]}
                    tags_text += '<li><a href="http://www.openstreetmap.org/node/'+ geo.features[i].properties['id'] +'" target="_blank">Voir sur OSM</a></ul>'
                    geo.features[i].properties['popup_content'] = geo.features[i].properties.tags.name + "<br>"
                    
                    if (already_in)
                        {
                        geo.features[i].properties['popup_content'] += '<a href="#" onClick="remove_stop_from_relation(' + geo.features[i].properties['id'] + ','+ osm_relation_code +')"> Retirer cet arrt du parcours </a><br>';  
                        geo.features[i].properties['icon_url'] = 'assets/blue_bus.png';
                        }
                    else
                        {
                        geo.features[i].properties['popup_content'] += '<a href="#" onClick="add_stop_to_relation(' + geo.features[i].properties['id'] + ','+ osm_relation_code +')"> Ajouter cet arrt au parcours  </a><br>';  
                        geo.features[i].properties['icon_url'] = 'assets/red_bus.png';
                        }
                    
                    geo.features[i].properties['popup_content'] += tags_text + '<br>' + relations_text

                
            }
        }
        bus_layer = L.geoJson(geo, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup(feature.properties['popup_content']);
                layer.setIcon(L.icon({
                  iconUrl: feature.properties['icon_url'],
                  popupAnchor: [0, 0]
                }));                
            },
        }).addTo(map);    
    });
} 
L.easyButton('fa-bus', 
              function (){
                  display_bus_around();
              },
             'Afficher les arrts de bus  proximit'
);  
  
  </script>
</body>
</html>

